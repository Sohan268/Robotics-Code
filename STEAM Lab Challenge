#include <kipr/wombat.h>

//Define Variables
int rmotor = 0;
int lmotor = 3;
int forward_speed = 40;
int backward_speed = -40;
int slow_forward_speed = 20;
int slow_backward_speed = -20;


int back_sensor = 0;
int line_follow_sensor = 0;
int stop_sensor = 1;
int back_bottom_sensor = 5;

int bottomtarget = 1000;

int start_0 = 300;
int end_0 = 1700;

int start_1 = 1200;
int end_1 = 1700;

int servo_0 = 0;
int servo_1 = 1;
int servo_2 = 2;

int main()
{
    wait_for_light(3);
    shut_down_in(120.0);

    capture_botguy();				//capture botguy
    
    lift_mini_servo();				//lift and hold mini servo in up position
    
    while(digital(back_sensor) == 0)		//back up into wall until back sensor is pushed
    {
        backward();
    }
    ao();
    
    medium_lift();					//lift claw over second group of poms
    
    turn_left();					//turn robot left to align with second group of poms
    msleep(450);
    ao();
    
    open_claw();					//open claw to collect poms
    
    drop();						//drop claw
        
    while(analog(stop_sensor) < 3000)	//line follow along the center black line with 
    {
        if(analog(line_follow_sensor) < bottomtarget)
        {
            right_turn_mini();
        }

    	if(analog(line_follow_sensor) > bottomtarget)
    	{
        	left_turn_mini();
    	}
    }
    ao();
    
    forward();					//bypass tape in base
    msleep(1000);
    ao();
    
    while(analog(stop_sensor) < 3000)	//continue line follow aling the center black line
    {
        if(analog(line_follow_sensor) < bottomtarget)
        {
            right_turn_mini();
        }

    	if(analog(line_follow_sensor) > bottomtarget)
    	{
        	left_turn_mini();
    	}
    }
    ao();
    
    backward();					//back up after stopping
    msleep(150);
    ao();
        
    close_claw();					//close claw to collect poms

    transport_lift();				//lift claw over transporter
        
    msleep(1000);					//wait 1 second

    
    while(analog(stop_sensor) > 1000)	//sharp left turn until stop_sensor senses transporter 
    {
        left_turn_mini_sharp();
    }
    ao();

    forward();					//move forward to approach transporter
    msleep(1250);
    ao();
        
    open_claw();					//open claw to drop poms into transporter
    
    msleep(1000);					//wait 1 second
    
    shake();						//shake any remaining poms into transporter
        
    while(analog(5) < 2500)			//quickly back up until [sensor] senses center black line
    {
        fast_backward();
    }
    ao();

    forward();					//move forward
    msleep(400);
    ao();
    
    turn_right();					//turn right to better align with center black line
    msleep(800);
    ao();
    
    while(analog(2) < 3500)			//line follow along center black line 
    {
        if(analog(5) < bottomtarget)
        {
            right_turn_mini_2();
        }

    	if(analog(5) > bottomtarget)
    	{
        	left_turn_mini_2();
    	}
    }
    ao();
    
    close_claw();					//close claw

    lift_mini_servo();				//lift and hold up mini servo
    
    msleep(500);					//wait 0.5 seconds
    
    forward();					//move forward
    msleep(250);
    ao();
    
    slow_turn_right();				//slowly turn right to bypass black line of the farming zone
    msleep(4000);
    ao();
    
    while(analog(2) < 3500)			//continue slow turn right until [sensor] senses center black line
    {
        slow_turn_right();
    }
    ao();
    
    slow_turn_right();				//continue slow right turn to align with transporter
    msleep(1000);
    ao();
            
    while(digital(back_sensor) == 0)		//move quickly backwards until back_sensor is pressed
    {
        fast_backward();
    }
    ao();
    
    msleep(750);					//wait 0.75 seconds
    
    lift();						//lift claw to upright position
    
    msleep(750);					//wait 0.75 seconds
    
    drop_mini_servo();				//drop and hold mini servo
                
    fast_forward();				//move forward for 6.25 seconds, leaving transporter in farming zone
    msleep(6250);					//and botguy in the shelter
    ao();
        
    return 0;					//end program
}

void forward()
{
    motor(lmotor, forward_speed);
    motor(rmotor, forward_speed); 
}

void backward()
{
    motor(lmotor, backward_speed);
    motor(rmotor, backward_speed); 
}

void slow_forward()
{
    motor(lmotor, slow_forward_speed);
    motor(rmotor, slow_forward_speed);
}

void slow_backward()
{
    motor(lmotor, slow_backward_speed);
    motor(rmotor, slow_backward_speed); 
}

void fast_forward()
{
    motor(lmotor, 60);
    motor(rmotor, 65); 
}

void fast_backward()
{
    motor(lmotor, -55);
    motor(rmotor, -95); 
}
          
void turn_left()
{
    motor(lmotor, backward_speed);
    motor(rmotor, forward_speed);
}

void turn_right()
{
    motor(lmotor, forward_speed);
    motor(rmotor, backward_speed);
}

void slow_turn_left()
{
    motor(lmotor, slow_backward_speed);
    motor(rmotor, slow_forward_speed);
}

void slow_turn_right()
{
    motor(lmotor, slow_forward_speed);
    motor(rmotor, slow_backward_speed);
}

void right_turn_mini()
{
    motor(lmotor,70);
    motor(rmotor,50);
}

void left_turn_mini()
{
    motor(lmotor,50);
    motor(rmotor,70);
}

void right_turn_mini_2()
{
    motor(lmotor,50);
    motor(rmotor,20);
}

void left_turn_mini_2()
{
    motor(lmotor,20);
    motor(rmotor,50);
}


void left_turn_mini_sharp()
{
    motor(lmotor,-30);
    motor(rmotor,30);
}
         
void capture_botguy()
{
    forward();
    msleep(1750);
    ao();
    
    enable_servos();
    
    while(start_0<end_0)
    {
        set_servo_position(servo_1, start_0);
        msleep(20);
        start_0 = start_0 + 10;
    }
        
    disable_servos();
}

void lift()
{
    enable_servos();
    
    set_servo_position(servo_1, 300);
    msleep(500);
        
    disable_servos();
}

void medium_lift()
{
    enable_servos();
    
    set_servo_position(servo_1, 1200);
    msleep(750);
        
    disable_servos();
}

void transport_lift()
{
    enable_servos();
    
    set_servo_position(servo_1, 1300);
    msleep(750);
            
    disable_servos();
}


void little_lift()
{
    enable_servos();
    
    set_servo_position(servo_1, 1400);
    msleep(500);
        
    disable_servos();
}

void drop()
{
    enable_servos();
    
    while(start_1<end_1)
    {
        set_servo_position(servo_1, start_1);
        msleep(20);
        start_1 = start_1 + 10;
    }
        
    disable_servos();
}

void open_claw()
{
    enable_servos();
    
    set_servo_position(servo_0, 1700);
    msleep(1000);
        
    disable_servos();
}

void close_claw()
{
    enable_servos();
    
    set_servo_position(servo_0, 900);
    msleep(1000);
        
    disable_servos();
}

void shake()
{
    enable_servos();
    
    set_servo_position(servo_1, 1300);
    msleep(250);
    
   	set_servo_position(servo_1, 1200);
    msleep(250);
    
    set_servo_position(servo_1, 1300);
    msleep(250);
    
   	set_servo_position(servo_1, 1200);
    msleep(250);
    
    disable_servos();
}

void lift_mini_servo()
{
    enable_servos();
    
    set_servo_position(servo_2, 1000);
    msleep(200);
}

void drop_mini_servo()
{
    enable_servos();
    
    set_servo_position(servo_2, 100);
    msleep(200);
}

